<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heatmap</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <link href='./css/mapbox-gl.css' rel='stylesheet'/>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #tooltip:empty {
            display: none;
        }

        #tooltip {
            font-family: Helvetica, Arial, sans-serif;
            position: absolute;
            padding: 4px;
            margin: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            max-width: 300px;
            font-size: 10px;
            z-index: 9;
            pointer-events: none;
        }
    </style>

    <script type="text/javascript" src="./js/global-mercator.js"></script>
    <script type="text/javascript" src="./js/mapbox-gl.js"></script>
    <script type="text/javascript" src="./js/browser-connector.js"></script>
    <script type="text/javascript" src="./js/pako.js"></script>
    <script type="text/javascript" src="./js/vectortile-utils.js"></script>
    <script type="text/javascript" src="./js/moment.js"></script>

    <script type="text/javascript" src="./js/turf.min.js"></script>
    <script type="text/javascript" src="./js/wellknown.js"></script>
    <script type="text/javascript" src="./js/mapbox-gl-draw.js"></script>
    <link href='./css/mapbox-gl-draw.css' rel='stylesheet'/>

<!--    <link rel="preconnect" href="http://fbg01:4762">-->
<!--    <link rel="preconnect" href="http://fbg01:4763">-->
<!--    <link rel="preconnect" href="http://fbg01:4764">-->
<!--    <link rel="preconnect" href="http://fbg01:4765">-->
<!--    <link rel="preconnect" href="http://fbg01:4766">-->
<!--    <link rel="preconnect" href="http://fbg01:4767">-->
<!--    <link rel="preconnect" href="http://fbg01:4768">-->
<!--    <link rel="preconnect" href="http://fbg01:4769">-->
<!--    <link rel="preconnect" href="http://fbg01:4770">-->
<!--    <link rel="preconnect" href="http://fbg01:4771">-->
<!--    <link rel="preconnect" href="http://fbg01:4772">-->
<!--    <link rel="preconnect" href="http://fbg01:4773">-->
</head>
<body>
<div id='map'></div>
<div id="tooltip"></div>

<script>
    mapboxgl.workerCount = 32;
    mapboxgl.maxParallelImageRequests = 32;

    const bbox = [126.76487604016523, 37.42806780710028, 127.18416090045505, 37.70130441174812]; // seoul

    const radius = (function () {
        const mercator = new GlobalMercator();
        const BIN_SIZE = 500.0;
        const longitude = 126.96099658228684;
        const latitude = 37.54371621174512;
        const meters1 = mercator.LatLonToMeters(latitude, longitude);
        const radius = [
            'interpolate',
            ['linear'],
            ['zoom']
        ]
        for (let zoom = 0; zoom <= 22; zoom++) {
            const pixels = mercator.MetersToPixels_Double(meters1[0], meters1[1], zoom);
            const raster1 = mercator.PixelsToRaster_Double(pixels[0], pixels[1], zoom);
            const raster2 = [raster1[0] + 1, raster1[1]];
            const meters2 = (function () {
                const pixels = mercator.RasterToPixels_Double(raster2[0], raster2[1], zoom);
                return mercator.PixelsToMeters(pixels[0], pixels[1], zoom);
            })();
            const calc = Math.max(1, Math.round(BIN_SIZE / Math.abs(meters1[0] - meters2[0])));
            // const calc = Math.round(BIN_SIZE / Math.abs(meters1[0] - meters2[0]));
            radius.push(zoom);
            radius.push(calc);
            // console.log(zoom, Math.abs(meters1[0] - meters2[0]), calc);
        }
        // return radius;
        return [
            'interpolate',
            ['linear'],
            ['zoom'],
            0, 1,
            1, 2,
            2, 2,
            3, 2,
            4, 3,
            5, 3,
            6, 3,
            7, 10,
            8, 10,
            9, 10,
            10, 10,
            11, 10,
            12, 20,
            13, 20,
            14, 40,
            15, 80,
            16, 90,
            17, 40,
            18, 50,
            19, 60,
            20, 70,
            21, 80,
            22, 100
        ];
    })();

    // const host = "127.0.0.1";
    // const ports = [8080];
    const host = "fbg01";
    const ports = [4762, 4763, 4764, 4765, 4766, 4767, 4768, 4769, 4770, 4771, 4772, 4773];
    const eventTimeFormat = "YYYYMMDDhhmm";
    let eventTime = null;

    const map = new mapboxgl.Map({
        container: 'map', // container id
        hash: true,
        style: {
            'version': 8,
            'sources': {
                'raster-tiles': {
                    'type': 'raster',
                    'tiles': [
                        'http://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
                    ],
                    'tileSize': 256
                }
            },
            'layers': [{
                'id': 'base-map',
                'type': 'raster',
                'source': 'raster-tiles',
                'minzoom': 0,
                'maxzoom': 22
            }]
        },
        center: [126.96099658228684, 37.54371621174512], // starting position
        zoom: 15, // starting zoom
        tilesFunctionParams: function (tile) {
            const port = ports.shift();
            ports.push(port);

            const maxEventTime = moment(eventTime.max, eventTimeFormat);
            const eventTime1 = maxEventTime.format(eventTimeFormat);

            const time = moment.duration("00:03:00");
            const eventTime2 = maxEventTime.subtract(time).format(eventTimeFormat);

            console.log(eventTime1, eventTime2);

            // var sql = "SELECT exist_m_00, exist_m_10, exist_m_20, exist_m_30, exist_m_40, exist_m_50, exist_m_60, exist_m_70, exist_m_80, exist_m_90, exist_f_00, exist_f_10, exist_f_20, exist_f_30, exist_f_40, exist_f_50, exist_f_60, exist_f_70, exist_f_80, exist_f_90, geometry FROM ltdb_fp WHERE event_time = '202103151000'";
            // var typeName = "ltdb_fp";
            // var aggrType = "sum";
            // var multiple = false;
            //
            // renderSqlRest(host, port, {tileID: {canonical: {z: tile.zoom, x: tile.tx, y: tile.ty}}}, sql, typeName, aggrType, multiple, bbox);

            return {
                host: host,
                port: port,
                eventTime1: eventTime1,
                eventTime2: eventTime2
            }
        }
    });

    const draw = new MapboxDraw({
        displayControlsDefault: false,
// Select which mapbox-gl-draw control buttons to add to the map.
        controls: {
            circle: true,
            polygon: true,
            trash: true
        }
    });

    // Map#addControl takes an optional second argument to set the position of the control.
    // If no position is specified the control defaults to `top-right`. See the docs
    // for more details: https://docs.mapbox.com/mapbox-gl-js/api/#map#addcontrol

    map.addControl(draw, 'top-left');

    Promise.all([
        new Promise(function (resolve, reject) {
            map.on('load', function () {
                resolve('loaded');
            });
        }),
        new MapdCon()
            .host(host)
            .port(ports[0])
            .dbName("default")
            .user("ltdb")
            .password("ltdb")
            .connectAsync()
            .then(function (connector) {
                return connector.queryAsync("SELECT min(event_time), max(event_time) FROM ltdb_fp limit 1", {columnarResults: false});
            }),
        new MapdCon()
            .host(host)
            .port(ports[0])
            .dbName("default")
            .user("ltdb")
            .password("ltdb")
            .connectAsync()
            .then(function (connector) {
                return connector.queryAsync("SELECT sum(exist_m_00) + sum(exist_m_10) + sum(exist_m_20) + sum(exist_m_30) + sum(exist_m_40) + sum(exist_m_50) + sum(exist_m_60) + sum(exist_m_70) + sum(exist_m_80) + sum(exist_m_90) + sum(exist_f_00) + sum(exist_f_10) + sum(exist_f_20) + sum(exist_f_30) + sum(exist_f_40) + sum(exist_f_50) + sum(exist_f_60) + sum(exist_f_70) + sum(exist_f_80) + sum(exist_f_90) as a_a FROM ltdb_fp WHERE event_time = '202103151000' limit 1", {columnarResults: false});
            })
    ]).then(function (result) {
        eventTime = (function () {
            return {min: result[1][0]["min(event_time)"], max: result[1][0]["max(event_time)"]};
        })();
        console.log(eventTime);
        const total = (function () {
            let total = 0;
            for (let key in result[2][0]) {
                total += result[2][0][key];
            }
            return total;
        })();
        console.log(result[2]);
        console.log(total);
        map.style.dispatcher.broadcast('loadWorkerSource', {
            name: "pako",
            url: "http://localhost:63342/ltdb-http/examples/js/pako.js"
        }, function (e) {
            if (e) {
                console.log(e);
            }
        });
        map.style.dispatcher.broadcast('loadWorkerSource', {
            name: "global-mercator",
            url: "http://localhost:63342/ltdb-http/examples/js/global-mercator.js"
        }, function (e) {
            if (e) {
                console.log(e);
            }
        });
        map.style.dispatcher.broadcast('loadWorkerSource', {
            name: "browser-connector",
            url: "http://localhost:63342/ltdb-http/examples/js/browser-connector.js"
        }, function (e) {
            if (e) {
                console.log(e);
            }
        });
        map.style.dispatcher.broadcast('loadWorkerSource', {
            name: "vectortile-utils",
            url: "http://localhost:63342/ltdb-http/examples/js/vectortile-utils.js"
        }, function (e) {
            if (e) {
                console.log(e);
            }
        });
        // 14 13968 6345
        // new MapdCon()
        //     .host(host)
        //     .port(port)
        //     .dbName("default")
        //     .user("ltdb")
        //     .password("ltdb")
        //     .connectAsync().then(function (connector) {
        //     return connector.renderVegaAsync("1", JSON.stringify({
        //         "sql": "SELECT * FROM ltdb_fp",
        //         "zoom": 14,
        //         "tx": 13968,
        //         "ty": 6345,
        //         "typeName": "ltdb_fp",
        //         "aggrType": "sum"
        //     }), {}).then(function (response) {
        //         console.log(response);
        //         return response.arrayBuffer();
        //     });
        // });
        map.addSource('vector-tile', {
            type: 'vector',
            tilesFunction: `function (tile) {
                    var host = tile.tilesFunctionParams.host;
                    var port = tile.tilesFunctionParams.port;
                    var eventTime1 = tile.tilesFunctionParams.eventTime1;
                    var eventTime2 = tile.tilesFunctionParams.eventTime2;

                    var sql = "SELECT exist_m_00 + exist_m_10 + exist_m_20 + exist_m_30 + exist_m_40 + exist_m_50 + exist_m_60 + exist_m_70 + exist_m_80 + exist_m_90 + exist_f_00 + exist_f_10 + exist_f_20 + exist_f_30 + exist_f_40 + exist_f_50 + exist_f_60 + exist_f_70 + exist_f_80 + exist_f_90 as a_a, geometry FROM ltdb_fp WHERE event_time = '" + eventTime1 + "'";
                    var typeName = "ltdb_fp";
                    var aggrType = "sum";
                    var multiple = false;
                    // var bbox = ${JSON.stringify(bbox)};
                    var bbox = null;
                    return renderSqlPost(host, port, tile, sql, typeName, aggrType, multiple, bbox, 1.0);
                }`,
            minzoom: 0,
            maxzoom: 22,
        });
        const weight = [
            'interpolate',
            ['linear'],
            ['get', 'a_a'],
            0, 0,
            total / 4, 0.5,
            total, 1
        ];

        const max = [
            'max',
            ['get', 'a_a']
        ];

        const sum = ["+",
            ['get', 'a_a']
        ]

        map.addLayer(
            {
                id: 'vector-tile',
                type: 'heatmap',
                source: 'vector-tile',
                'source-layer': 'ltdb_fp',
                'paint': {
                    // 'heatmap-weight': [
                    //     'interpolate',
                    //     ['linear'],
                    //     ['get', 'exist_f_30'],
                    //     0, 0,
                    //     weight, 1
                    // ],
                    'heatmap-weight': weight,
                    // Increase the heatmap color weight weight by zoom level
// heatmap-intensity is a multiplier on top of heatmap-weight
//                     'heatmap-intensity': [
//                         'interpolate',
//                         ['linear'],
//                         ['zoom'],
//                         0, 1,
//                         22, 3
//                     ],
// Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
// Begin color ramp at 0-stop with a 0-transparancy color
// to create a blur-like effect.
//                     'heatmap-color': [
//                         'interpolate',
//                         ['linear'],
//                         ['heatmap-density'],
//                         0, 'rgba(33,102,172, 0)',
//                         0.2, 'rgb(103,169,207)',
//                         0.4, 'rgb(209,229,240)',
//                         0.6, 'rgb(253,219,199)',
//                         0.8, 'rgb(239,138,98)',
//                         1, 'rgb(178,24,43)'
//                     ],
//                     "heatmap-color": [
//                         'step', ['heatmap-density'], 'rgba(33,102,172,0)',
//                         0.2, 'rgb(103,169,207)',
//                         0.4, 'rgb(209,229,240)',
//                         0.6, 'rgb(253,219,199)',
//                         0.8, 'rgb(239,138,98)',
//                         1, 'rgb(178,24,43)'
//                     ],
                    "heatmap-color": [
                        'step', ['heatmap-density'], 'rgba(255, 255, 254, 0)',
                        0.05, 'rgb(255, 255, 204)',
                        0.2, 'rgb(255, 240, 168)',
                        0.3, 'rgb(254, 225, 134)',
                        0.4, 'rgb(254, 201, 101)',
                        0.5, 'rgb(253, 170, 72)',
                        0.6, 'rgb(253, 141, 60)',
                        0.7, 'rgb(252, 90, 45)',
                        0.8, 'rgb(237, 46, 33)',
                        0.9, 'rgb(211, 15, 32)',
                        1, 'rgb(176, 0, 38)'
                    ],
// Adjust the heatmap radius by zoom level
                    'heatmap-radius': radius,
// Transition from heatmap to circle layer by zoom level
//                     'heatmap-opacity': [
//                         'interpolate',
//                         ['linear'],
//                         ['zoom'],
//                         7, 1,
//                         22, 0
//                     ],
                    'heatmap-opacity': 0.5,
                    'statistics-max': max,
                    'statistics-sum': sum
                },
                // filter: [
                //     "all",
                //     [">=", "longitude", bbox[0]],
                //     ["<=", "longitude", bbox[2]],
                //     [">=", "latitude", bbox[1]],
                //     ["<=", "latitude", bbox[3]]
                // ]
            }
        );

        // map.addLayer(
        //     {
        //         id: 'vector-tile2',
        //         type: 'circle',
        //         source: 'vector-tile',
        //         'source-layer': 'ltdb_fp',
        //         paint: {
        //             'circle-radius': 2,
        //             'circle-color': 'White'
        //         }
        //     }
        // );

        let dirty = true;
        map.on("moveend", (e) => {
            dirty = true;
        });

        map.on('idle', (e) => {
            if (!dirty) {
                return;
            }
            let max = Number.MIN_VALUE;
            let sum = 0;
            const config = map.getProgramConfigurations('vector-tile', 'vector-tile'); // sourceId, layerId
            for (let i = 0; i < config.length; i++) {
                // console.log(config[i].programConfigurations['vector-tile']);
                const maxValue = config[i].programConfigurations['vector-tile'].binders['statistics-max'].maxValue;
                const sumValue = config[i].programConfigurations['vector-tile'].binders['statistics-sum'].sumValue;

                max = Math.max(max, maxValue);
                sum += sumValue;
            }
            weight[5] = max / 4;
            weight[7] = max;
            console.log('max', max);
            console.log('sum', sum);
            map.setPaintProperty('vector-tile', 'heatmap-weight', weight);
            dirty = false;
        });
    });

    function calculateStats(propertyNames) {
        const features = map.querySourceFeatures('vector-tile', {
            'sourceLayer': 'ltdb_fp'
        });

        let sum = 0;
        let max = null;
        let min = null;
        let first = true;
        for (let i = 0; i < features.length; i++) {
            let s = 0;
            for (let key in features[i].properties) {
                if (isNaN(features[i].properties[key])) {
                    if (first) {
                        console.log(features[i]);
                        first = false;
                    }
                    continue;
                }
                if (propertyNames && propertyNames.indexOf(key) === -1) {
                    continue;
                }
                s += features[i].properties[key];
            }
            if (!min) {
                min = s;
            }
            if (!max) {
                max = s;
            }
            min = Math.min(min, s);
            max = Math.max(max, s)
            sum += s;
        }
        console.log(min, max, sum);
    }

    function updateStatisticsOnDraw() {
        const data = draw.getAll();
        if (data.features.length > 0) {
            console.log(data.features);
            const wkt = wellknown.stringify(data.features[0].geometry);
            const maxEventTime = moment(eventTime.max, eventTimeFormat);
            const eventTime1 = maxEventTime.format(eventTimeFormat);

            const time = moment.duration("72:00:00");
            // const time = moment.duration("24:00:00");
            const eventTime2 = maxEventTime.subtract(time).format(eventTimeFormat);

            console.log(eventTime1, eventTime2);

            const subQuery = `
SELECT
    sum(exist_m_00) as exist_m_00, sum(exist_m_10) as exist_m_10, sum(exist_m_20) as exist_m_20, sum(exist_m_30) as exist_m_30,
    sum(exist_m_40) as exist_m_40, sum(exist_m_50) as exist_m_50, sum(exist_m_60) as exist_m_60, sum(exist_m_70) as exist_m_70,
    sum(exist_m_80) as exist_m_80, sum(exist_m_90) as exist_m_90,
    sum(exist_f_00) as exist_f_00, sum(exist_f_10) as exist_f_10, sum(exist_f_20) as exist_f_20, sum(exist_f_30) as exist_f_30,
    sum(exist_f_40) as exist_f_40, sum(exist_f_50) as exist_f_50, sum(exist_f_60) as exist_f_60, sum(exist_f_70) as exist_f_70,
    sum(exist_f_80) as exist_f_80, sum(exist_f_90) as exist_f_90,
    substring(event_time, 0, ${eventTimeFormat.length - 2}) as event_time
FROM ltdb_fp
WHERE ST_CONTAINS(ST_GEOMFROMTEXT('${wkt}'), geometry) AND event_time >= '${eventTime2}' AND event_time <= '${eventTime1}' GROUP BY event_time`;
//             const query = `
// SELECT sum(exist_m_00), sum(exist_m_10), sum(exist_m_20), sum(exist_m_30), sum(exist_m_40), sum(exist_m_50), sum(exist_m_60), sum(exist_m_70), sum(exist_m_80), sum(exist_m_90), sum(exist_f_00), sum(exist_f_10), sum(exist_f_20), sum(exist_f_30), sum(exist_f_40), sum(exist_f_50), sum(exist_f_60), sum(exist_f_70), sum(exist_f_80), sum(exist_f_90), event_time
// FROM (${subQuery}) GROUP BY event_time ORDER BY event_time`;
            const query = `
WITH statistics AS (${subQuery}) SELECT sum(exist_m_00), sum(exist_m_10), sum(exist_m_20), sum(exist_m_30), sum(exist_m_40), sum(exist_m_50), sum(exist_m_60), sum(exist_m_70), sum(exist_m_80), sum(exist_m_90), sum(exist_f_00), sum(exist_f_10), sum(exist_f_20), sum(exist_f_30), sum(exist_f_40), sum(exist_f_50), sum(exist_f_60), sum(exist_f_70), sum(exist_f_80), sum(exist_f_90), event_time
FROM statistics GROUP BY event_time ORDER BY event_time`;
            console.log(query);
            new MapdCon()
                .host(host)
                .port(ports[0])
                .dbName("default")
                .user("ltdb")
                .password("ltdb")
                .connectAsync()
                .then(function (connector) {
                    connector.queryAsync(query).then(function (statistics) {
                       console.log(statistics);
                       console.log(statistics.map(function (s) {
                           return s.event_time;
                       }));
                    });
                })
        }
    }
    map.on('draw.create', updateStatisticsOnDraw);
    map.on('draw.delete', updateStatisticsOnDraw);
    map.on('draw.update', updateStatisticsOnDraw);
</script>
</body>
</html>