<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heatmap</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <link href='./css/mapbox-gl.css' rel='stylesheet'/>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #tooltip:empty {
            display: none;
        }

        #tooltip {
            font-family: Helvetica, Arial, sans-serif;
            position: absolute;
            padding: 4px;
            margin: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            max-width: 300px;
            font-size: 10px;
            z-index: 9;
            pointer-events: none;
        }
    </style>

    <script type="text/javascript" src="./js/global-mercator.js"></script>
    <script type="text/javascript" src="./js/mapbox-gl.js"></script>
    <script type="text/javascript" src="./js/browser-connector.js"></script>
</head>
<body>
<div id='map'></div>
<div id="tooltip"></div>

<script>
    const radius = (function () {
        const mercator = new GlobalMercator();
        const BIN_SIZE = 500.0;
        const longitude = 126.96099658228684;
        const latitude = 37.54371621174512;
        const meters1 = mercator.LatLonToMeters(latitude, longitude);
        const radius = [
            'interpolate',
            ['linear'],
            ['zoom']
        ]
        for (let zoom = 0; zoom <= 22; zoom++) {
            const pixels = mercator.MetersToPixels_Double(meters1[0], meters1[1], zoom);
            const raster1 = mercator.PixelsToRaster_Double(pixels[0], pixels[1], zoom);
            const raster2 = [raster1[0] + 1, raster1[1]];
            const meters2 = (function () {
                const pixels = mercator.RasterToPixels_Double(raster2[0], raster2[1], zoom);
                return mercator.PixelsToMeters(pixels[0], pixels[1], zoom);
            })();
            const calc = Math.max(1, Math.round(BIN_SIZE / Math.abs(meters1[0] - meters2[0])));
            radius.push(zoom);
            radius.push(calc);
            // console.log(zoom, Math.abs(meters1[0] - meters2[0]), calc);
        }
        return radius;
    })();

    // const host = "127.0.0.1"
    // const port = 8080;
    const host = "fbg01";
    const port = 4762;

    const map = new mapboxgl.Map({
        container: 'map', // container id
        hash: true,
        style: {
            'version': 8,
            'sources': {
                'raster-tiles': {
                    'type': 'raster',
                    'tiles': [
                        'http://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
                    ],
                    'tileSize': 256
                }
            },
            'layers': [{
                'id': 'base-map',
                'type': 'raster',
                'source': 'raster-tiles',
                'minzoom': 0,
                'maxzoom': 22
            }]
        },
        center: [126.96099658228684, 37.54371621174512], // starting position
        zoom: 15 // starting zoom
    });

    Promise.all([
        new Promise(function (resolve, reject) {
            map.on('load', function () {
                resolve('loaded');
            });
        }),
        new MapdCon()
            .host(host)
            .port(port)
            .dbName("default")
            .user("ltdb")
            .password("ltdb")
            .connectAsync()
            .then(function (connector) {
                return connector.queryAsync("SELECT SUM(exist_f_30) FROM ltdb_fp WHERE event_time = '202103171055' limit 1", {columnarResults: false});
            })
    ]).then(function (result) {
        const sum = result[1][0]["sum(exist_f_30)"];
        const weight = sum / 50000;
        console.log(sum);
        map.style.dispatcher.broadcast('loadWorkerSource', {
            name: "browser-connector",
            url: "http://localhost:63342/ltdb-http/examples/js/browser-connector.js"
        }, function (e) {
            if (e) {
                console.log(e);
            }
        });
        // 14 13968 6345
        // new MapdCon()
        //     .host(host)
        //     .port(port)
        //     .dbName("default")
        //     .user("ltdb")
        //     .password("ltdb")
        //     .connectAsync().then(function (connector) {
        //     return connector.renderVegaAsync("1", JSON.stringify({
        //         "sql": "SELECT * FROM ltdb_fp",
        //         "zoom": 14,
        //         "tx": 13968,
        //         "ty": 6345,
        //         "typeName": "ltdb_fp",
        //         "aggrType": "sum"
        //     }), {}).then(function (response) {
        //         console.log(response);
        //         return response.arrayBuffer();
        //     });
        // });
        map.addSource('vector-tile', {
            type: 'vector',
            tilesFunction: `function (tile) {
                    function _base64ToArrayBuffer(base64) {
                        var binary_string = atob(base64);
                        var len = binary_string.length;
                        var bytes = new Uint8Array(len);
                        for (var i = 0; i < len; i++) {
                            bytes[i] = binary_string.charCodeAt(i);
                        }
                        return bytes.buffer;
                    }
                    var mapdCon = new MapdCon();
                    mapdCon._protocol = ['http'];
                    return mapdCon
                        .host("${host}")
                        .port(${port})
                        .dbName("default")
                        .user("ltdb")
                        .password("ltdb")
                        .connectAsync().then(function (connector) {
                        return connector.renderVegaAsync("1", JSON.stringify({
                            "sql": "SELECT * FROM ltdb_fp WHERE event_time = '202103171055'",
                            "zoom": tile.tileID.canonical.z,
                            "tx": tile.tileID.canonical.x,
                            "ty": tile.tileID.canonical.y,
                            "typeName": "ltdb_fp",
                            "aggrType": "sum"
                        }), {});
                    }).then(function (response) {
                        // console.log(response);
                        return _base64ToArrayBuffer(response.image);
                    });
                }`,
            minzoom: 0,
            maxzoom: 22
        });
        map.addLayer(
            {
                id: 'vector-tile',
                type: 'heatmap',
                source: 'vector-tile',
                'source-layer': 'ltdb_fp',
                'paint': {
                    'heatmap-weight': [
                        'interpolate',
                        ['linear'],
                        ['get', 'exist_f_30'],
                        0, 0,
                        weight, 1
                    ],
                    // Increase the heatmap color weight weight by zoom level
// heatmap-intensity is a multiplier on top of heatmap-weight
//                     'heatmap-intensity': [
//                         'interpolate',
//                         ['linear'],
//                         ['zoom'],
//                         0, 1,
//                         22, 3
//                     ],
// Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
// Begin color ramp at 0-stop with a 0-transparancy color
// to create a blur-like effect.
//                     'heatmap-color': [
//                         'interpolate',
//                         ['linear'],
//                         ['heatmap-density'],
//                         0, 'rgba(33,102,172, 0)',
//                         0.2, 'rgb(103,169,207)',
//                         0.4, 'rgb(209,229,240)',
//                         0.6, 'rgb(253,219,199)',
//                         0.8, 'rgb(239,138,98)',
//                         1, 'rgb(178,24,43)'
//                     ],
                    "heatmap-color": [
                        'step', ['heatmap-density'], 'rgba(33,102,172,0)',
                        0.2, 'rgb(103,169,207)',
                        0.4, 'rgb(209,229,240)',
                        0.6, 'rgb(253,219,199)',
                        0.8, 'rgb(239,138,98)',
                        1, 'rgb(178,24,43)'
                    ],
// Adjust the heatmap radius by zoom level
                    'heatmap-radius': radius,
// Transition from heatmap to circle layer by zoom level
//                     'heatmap-opacity': [
//                         'interpolate',
//                         ['linear'],
//                         ['zoom'],
//                         7, 1,
//                         22, 0
//                     ],
                    'heatmap-opacity': 0.5
                }
            }
        );
    });
</script>
</body>
</html>